# 定时任务服务模块

## 核心模块

1. executor: 执行器模块
2. scheduler: 调度器模块
3. trigger: 触发器模块
4. migrator: 迁移器模块

## 高精准

**秒级精准**

任务触发时间的误差（`cost_time`） = 扫描间隔时间(`<= 1s`) + 任务执行时间(`run_time` - `callback_time`)

- 高频扫描（每隔1秒）：基于 ZSET 数据的顺序性，以及整体的横纵分治策略设计，使得基于单个分片的单次判断耗时不会太长，同时即便进行短时高频的查询扫描，也不会带来太大的性能开销
- 并发执行任务：采用了并发执行任务的方案，让批量任务尽可能的并发执行，减少等待时间

## 高负载

- 横纵分治策略：根据时间（分钟间隔）以及桶数（并发数），让不同的线程去跟进分片的处理，提高并发度；让同一时间范围内的多个分片中的任务可以并发处理
- 线程池：单批次任务处理过程中，采用线程池技术

## 异常任务处理 todo

- 定时脚本：单独运行一个定时脚本，每 5 分钟跑一次。扫描 `timer_task` 表中超过运行时间 `run_time` 但执行不成功（`status`）
  ）的任务重新触发执行
- 人工介入重试

## 迁移器模块 + 二级缓存

### 迁移器模块

**迁移器 migrator** 模块执行时机：

- 调用激活定时任务接口时进行任务迁移
    - 生成被激活任务未来 2 * migrateStepSeconds 秒（2 小时）内将要执行的任务
- 定时触发任务迁移，每 60 * 60 * 1000 毫秒（2 小时）进行一次迁移
    - **生成未来 2 * migrateStepSeconds 秒（2 小时）内将要执行的任务**

### 定时任务**批量打点**

基于定时任务中关于执行时间的定义（cron expression），推算未来一段时间内以整个批次的执行时间并进行批量打点

### 数据冷热分区

**Redis 分片中仅存储未来两小时将要执行的"热"任务（数据）**，而不存储过远的未来"冷"任务（数据）

### MySQL + Redis 二级缓存设计

#### MySQL

- `timer` 表存储创建的定时任务信息
- `timer_task` 表存储迁移器模块生成的要执行的任务信息

#### Redis

Redis ZSET 分片 key 格式：`yyyy-MM-dd HH:mm_bucketId`（`分钟级时间_桶ID`）

- 实现**横向**根据时间分片
- 实现**纵向**根据桶 ID （并发线程数）分片

每个 `分钟级时间_桶ID` ZSET 分片中存储着当前分钟内将要执行的任务 ID

## 调度流程

### 调度器模块

1. **Scheduler** 调度器模块以 1 秒为间隔进行主动轮询，基于当前时刻推算出对应的分钟级时间范围表达式
2. 读取配置获得最大桶数的信息，基于时间范围拼接桶号，获得当前需要关心的一系列二维分片的 key
3. 尝试抢占对应于每一个二维分片的分布式锁，并将锁的过期时间设置为一个**大于 1 倍分片时间，小于 2 倍分片时间的值**
4. 获取锁成功则调度一个触发器进行作业

### 触发器模块

1. 触发器在调度器模块传递对应分片的时间范围内，对分片进行间隔 1 秒的轮询
2. 将达到执行条件的定时任务取出，不断从线程池中取出对应于任务数量的线程，在线程中调用执行器模块，用于执行定时任务
3. 当触发器线程完成任务后，会将该分片对应的分布式锁的过期时间更新为一个**大于 2 倍分片时间范围的值**

**关于分片对应的分布式锁两次设置过期时间的解释：**

1. 第一次：分布式锁超时时间 tryLockSeconds（1T < N < 2T）
2. 第二次：延时时间 successExpireSeconds（N > 2T）的解释

**At least Once 兜底重试机制：** 每次执行当前时间分片任务前，“重复执行上一时间分片的任务”

- 不管是重复执行还是第一次执行都需要获取对应时间分片的分布式锁
- 如果第一次执行成功，则会延长对应分片分布式锁的过期时间；如果第一次执行不成功，则不会延长对应分片分布式锁的过期时间
- 重复执行上一时间分片任务时，会获取上一时间分片的分布式锁，如果获取成功（第一次执行不成功）则重新执行，如果获取失败（第一次执行成功）则不执行

### 执行器模块

执行器由触发器异步启动，一个执行器线程对应一个定时任务

1. 执行器首先对定时任务进行幂等去重（判断任务是否已执行）
2. 根据消息中的定时任务 id，查询到定时任务的完整信息
3. 执行定时任务
4. 更新 `timer_task` 表中的任务状态
